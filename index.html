<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ëª©ë°•ì‚¬ RPG - ë ˆì´ì•„ì›ƒ&ì´ë¯¸ì§€ í†µí•©</title>
<style>
  :root{
    --bg:#0e0f12; --card:#171922; --ink:#e9ecf2; --muted:#a6b0c3;
    --accent:#6ae2ff; --accent2:#9d7cff; --good:#57f287; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0c10,#14161d);color:var(--ink);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic}
  .grid{
    display:grid;
    grid-template-columns: 280px 1fr;
    grid-template-rows: 1fr auto;
    min-height:100dvh;
    gap:12px;
  }
  .panel{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 10px 30px #0006}
  /* ì¢Œì¸¡: ìŠ¤íƒ¯ */
  #stats{grid-column:1;grid-row:1/3;display:flex;flex-direction:column;gap:8px}
  #stats h2{margin:0 0 6px;color:var(--accent);font-size:18px}
  .row{display:flex;justify-content:space-between;gap:8px;margin:2px 0;color:var(--muted)}
  .bar{height:10px;background:#2a2f3d;border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .hidden{display:none}
  .tag{font-size:12px;color:#cbd5e1;background:#1f2430;border-radius:8px;padding:2px 8px;display:inline-block}

  /* ì¤‘ì•™: ì¥ë©´ ì´ë¯¸ì§€ */
  #scene{grid-column:2;grid-row:1;position:relative;display:flex;align-items:center;justify-content:center;min-height:420px;overflow:hidden}
  #scene img{width:100%;height:100%;object-fit:cover;border-radius:10px;opacity:.96}
  #scene .overlay{position:absolute;right:10px;top:10px;display:flex;gap:6px;flex-wrap:wrap}
  .btn{background:#232633;color:var(--ink);border:none;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
  .btn:hover{filter:brightness(1.12)}

  /* ì•„ë˜: ëŒ€ì‚¬/ì„ íƒì§€ */
  #dialogueBar{grid-column:1/3;grid-row:2}
  #dialogue{white-space:pre-line;line-height:1.55;min-height:86px;color:var(--ink)}
  #choices{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
  #choices .btn{padding:9px 12px}

  /* í”Œë¡œíŒ… */
  #locationBtn{position:fixed;left:16px;bottom:16px;z-index:40}
  #inventoryBtn{position:fixed;right:16px;bottom:16px;z-index:40}
  #imageBtn{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:40}
  #locationList, #inventory, #imagePanel{
    position:fixed;bottom:70px;z-index:50;display:none;max-width:92vw
  }
  #locationList{left:16px;width:260px}
  #inventory{right:16px;width:320px}
  #imagePanel{left:50%;transform:translateX(-50%);width:520px}
  #invList .row{align-items:center}
  @media (max-width:900px){
    .grid{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}
    #stats{grid-column:1;grid-row:auto;flex-direction:row;flex-wrap:wrap}
    #scene{grid-column:1}
    #dialogueBar{grid-column:1}
  }
</style>
</head>
<body>
<div class="grid">
  <!-- ì™¼ìª½: ìŠ¤íƒ¯ -->
  <section id="stats" class="panel">
    <h2>ğŸ“Š ìŠ¤íƒ¯</h2>
    <div class="row"><span>ì²´ë ¥</span><span id="hpText"></span></div>
    <div class="bar"><div id="hpBar" class="fill"></div></div>
    <div class="grid2" style="margin-top:8px">
      <div class="row"><span>ê³µê²©ë ¥</span><b id="atkText"></b></div>
      <div class="row"><span>ì§€ëŠ¥</span><b id="intText"></b></div>
      <div class="row"><span>ë°©ì–´ë ¥</span><b id="defText"></b></div>
      <div class="row"><span>ëˆ</span><b id="moneyText"></b></div>
      <div class="row"><span>ëª…ì˜ˆ</span><b id="honorText"></b></div>
      <div class="row"><span>í„´</span><b id="turnText"></b></div>
    </div>
    <div id="dungeonExtra" class="grid2 hidden" style="margin-top:8px">
      <div class="row"><span>ë§ˆë‚˜</span><b id="mpText"></b></div>
      <div class="row"><span>ì¹˜ëª…íƒ€</span><b id="critText"></b></div>
    </div>
  </section>

  <!-- ì¤‘ì•™: ì¥ë©´ ì´ë¯¸ì§€ (+í–‰ë™ ì˜¤ë²„ë ˆì´) -->
  <section id="scene" class="panel">
    <img id="sceneImg" alt="ì¥ë©´ ì´ë¯¸ì§€ (ì—¬ê¸°ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤)">
    <div id="actionOverlay" class="overlay"></div>
    <div id="locationTag" class="tag" style="position:absolute;left:10px;top:10px">íŠœí† ë¦¬ì–¼</div>
  </section>

  <!-- ì•„ë˜: ëŒ€ì‚¬/ì„ íƒì§€ -->
  <section id="dialogueBar" class="panel">
    <div id="dialogue" class="muted"></div>
    <div id="choices"></div>
  </section>
</div>

<!-- í”Œë¡œíŒ… ë©”ë‰´ -->
<button id="locationBtn" class="btn">ğŸ—ºï¸ ì¥ì†Œ ì´ë™</button>
<div id="locationList" class="panel"></div>

<button id="inventoryBtn" class="btn">ğŸ’ ì¸ë²¤í† ë¦¬</button>
<div id="inventory" class="panel">
  <h3 style="margin:0 0 6px">ğŸ’ ì¸ë²¤í† ë¦¬</h3>
  <div id="invList" class="muted"></div>
</div>

<button id="imageBtn" class="btn">ğŸ´ ì´ë¯¸ì§€ ë“±ë¡</button>
<div id="imagePanel" class="panel">
  <h3 style="margin:0 8px 8px">ğŸ´ ì¥ë©´ ì´ë¯¸ì§€ ë“±ë¡</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <label>ì¥ë©´</label>
    <select id="sceneSelect" class="btn" style="padding:8px">
      <!-- JSì—ì„œ LOCATIONS + ì¸íŠ¸ë¡œ ë“±ë¡ -->
    </select>
    <input id="fileInput" type="file" accept="image/*" class="btn" style="padding:8px;background:#1f2430">
    <button id="applyImg" class="btn">ë“±ë¡</button>
  </div>
  <div class="muted" style="margin-top:8px">íŒŒì¼ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¥ë©´ì— ì´ë¯¸ì§€ë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤. ëŒ€í™”/ì´ë™ ì‹œ ìë™ í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
(() => {
  // ---------- Player & Data ----------
  const player = {
    hpMax: 100, hp: 100, mpMax: 40, mp: 40,
    atk: 10, def: 2, int: 0, crit: 10, // %
    money: 10000, honor: 0, turn: 1,
    inventory: {}
  };
  let starterClaimed = false;

  const ITEMS = {
    "ìŠ¤í¬ë©": {type:"ì¬ë£Œ", price:100},
    "ë°°í„°ë¦¬íŒ©": {type:"ì¬ë£Œ", price:400},
    "ê°•ì² ì¡°ê°": {type:"ì¬ë£Œ", price:300},
    "ì‘ê¸‰í‚¤íŠ¸": {type:"ì†Œëª¨", price:500, use: () => { player.hp = Math.min(player.hpMax, player.hp+40); say("ì‘ê¸‰í‚¤íŠ¸ ì‚¬ìš©! ì²´ë ¥ +40"); }},
    "ì§€ëŠ¥ì„œì ": {type:"ì†Œëª¨", price:1200, use: () => { player.int += 1; say("ì§€ëŠ¥ì„œì  ì‚¬ìš©! ì§€ëŠ¥ +1"); }},
    "ìŠ¤í¬ë©ì†Œë“œ": {type:"ë¬´ê¸°", price:1200, atk: +3},
    "ê³¼í•™ìì˜ë§ì¹˜": {type:"ë¬´ê¸°", price:3200, atk: +6},
  };

  const JUNK_EXCHANGE = [
    {name:"ì‘ê¸‰í‚¤íŠ¸", money:1500, honor:1},
    {name:"ì§€ëŠ¥ì„œì ", money:2000, honor:2},
    {name:"ê³¼í•™ìì˜ë§ì¹˜", money:4000, honor:3}
  ];

  const FUKO_SHOP = [
    {name:"ë°°í„°ë¦¬íŒ©", price:400},
    {name:"ê°•ì² ì¡°ê°", price:300},
    {name:"ì‘ê¸‰í‚¤íŠ¸", price:500},
    {name:"ì§€ëŠ¥ì„œì ", price:1200}
  ];

  const LOCATIONS = [
    "íŠœí† ë¦¬ì–¼","ê³ ë¬¼ê°€ê²Œ","í‘¸ì½”ìƒì ","í—¬ìŠ¤ì¥","ë„ì„œê´€",
    "ë„ë°•ì¥","ê³¼í•™ì‹¤","ì œë ¨ì†Œ","ì •ë³´ê±°ë˜ì†Œ","íŒë§¤ì†Œ","ë˜ì „"
  ];

  // ì¥ë©´ ì´ë¯¸ì§€ ì €ì¥ì†Œ (ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•˜ë©´ ì±„ì›Œì§)
  const SCENE_IMAGES = {
    // "ì¸íŠ¸ë¡œ1": blobUrl,
    // "íŠœí† ë¦¬ì–¼": blobUrl,
    // "ë˜ì „": blobUrl,
  };

  // ---------- DOM ----------
  const hpText = document.getElementById("hpText");
  const hpBar = document.getElementById("hpBar");
  const atkText = document.getElementById("atkText");
  const defText = document.getElementById("defText");
  const intText = document.getElementById("intText");
  const moneyText = document.getElementById("moneyText");
  const honorText = document.getElementById("honorText");
  const turnText = document.getElementById("turnText");
  const mpText = document.getElementById("mpText");
  const critText = document.getElementById("critText");
  const dungeonExtra = document.getElementById("dungeonExtra");

  const sceneImg = document.getElementById("sceneImg");
  const actionOverlay = document.getElementById("actionOverlay");
  const locationTag = document.getElementById("locationTag");

  const dialogue = document.getElementById("dialogue");
  const choices = document.getElementById("choices");
  const locationBtn = document.getElementById("locationBtn");
  const locationList = document.getElementById("locationList");
  const inventoryBtn = document.getElementById("inventoryBtn");
  const inventoryPanel = document.getElementById("inventory");
  const invList = document.getElementById("invList");

  const imageBtn = document.getElementById("imageBtn");
  const imagePanel = document.getElementById("imagePanel");
  const sceneSelect = document.getElementById("sceneSelect");
  const fileInput = document.getElementById("fileInput");
  const applyImg = document.getElementById("applyImg");

  // ---------- Utils ----------
  function updateStats(){
    hpText.textContent = `${player.hp}/${player.hpMax}`;
    hpBar.style.width = `${Math.max(0,Math.min(100, player.hp/player.hpMax*100))}%`;
    atkText.textContent = player.atk;
    defText.textContent = player.def;
    intText.textContent = player.int;
    moneyText.textContent = player.money.toLocaleString()+"ì›";
    honorText.textContent = player.honor;
    turnText.textContent = player.turn;
    mpText.textContent = `${player.mp}/${player.mpMax}`;
    critText.textContent = `${player.crit}%`;
    dungeonExtra.classList.toggle("hidden", currentLocation!=="ë˜ì „");
    renderInventory();
  }
  function gainItem(name, n=1){ player.inventory[name]=(player.inventory[name]||0)+n; }
  function consumeItem(name, n=1){
    if((player.inventory[name]||0) < n) return false;
    player.inventory[name]-=n; if(player.inventory[name]<=0) delete player.inventory[name]; return true;
  }
  function renderInventory(){
    if(Object.keys(player.inventory).length===0){ invList.innerHTML = `<div class="muted">ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    invList.innerHTML = "";
    for(const [k,v] of Object.entries(player.inventory)){
      const row=document.createElement("div"); row.className="row";
      const left=document.createElement("div"); left.textContent=`${k} x${v}`;
      const right=document.createElement("div");
      if(ITEMS[k]?.use){
        const b=document.createElement("button"); b.className="btn"; b.textContent="ì‚¬ìš©";
        b.onclick=()=>{ if(consumeItem(k,1)){ ITEMS[k].use(); updateStats(); } else alert("ìˆ˜ëŸ‰ ë¶€ì¡±"); };
        right.appendChild(b);
      }
      row.append(left,right); invList.appendChild(row);
    }
  }

  let typingLock=false;
  async function type(text){
    if(typingLock) return;
    typingLock=true;
    dialogue.textContent="";
    for(let i=0;i<text.length;i++){
      dialogue.textContent += text[i];
      await new Promise(r=>setTimeout(r, 16));
    }
    typingLock=false;
  }
  function say(text, sceneKey=null){
    if(sceneKey) showScene(sceneKey);
    type(text);
    choices.innerHTML="";
  }
  function showScene(key){
    const url = SCENE_IMAGES[key] || SCENE_IMAGES[currentLocation] || "";
    if(url){ sceneImg.src = url; }
    else{
      // ê¸°ë³¸ ë¹ˆ ì¥ë©´
      sceneImg.removeAttribute("src");
      sceneImg.alt = "ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•˜ì„¸ìš” (ğŸ´ ì´ë¯¸ì§€ ë“±ë¡ ë²„íŠ¼)";
    }
  }

  // ---------- Intro ----------
  const intro = [
    { text:`ë°•ì‚¬: ë“œë””ì–´....ë“œë””ì–´ ì¸ë¥˜ ìµœê³ ì˜ ë°œëª…í’ˆì„ ë§Œë“¤ì—ˆì–´ìš”!`, scene:"ì¸íŠ¸ë¡œ1" },
    { text:`ì¡°ìˆ˜: ê·¸ê²Œ ë­”ë°ìš” ë°•ì‚¬ë‹˜?`, scene:"ì¸íŠ¸ë¡œ2" },
    { text:`ë°•ì‚¬: ë‚´ ëª¨ëª¨ì§±ì„ ë‹®ì€ ë¬´ë“œë“±`, scene:"ì¸íŠ¸ë¡œ2" },
    { text:`ì¡°ìˆ˜: ì•„ë‹ˆ ê·¸ê±¸ ëˆ„ê°€ ì¨ìš”;;`, scene:"ì¸íŠ¸ë¡œ2" },
    { text:`ë°•ì‚¬: ...ì•„ ê·¸ëŸ°ê°€?`, scene:"ì¸íŠ¸ë¡œ2" },
    { text:`ì¡°ìˆ˜: í•˜....ì €ë„ ì´ì   ì§€ê²¹ë‹¤ê³ ìš”!! ì–¸ì œê¹Œì§€ ê·¸ë ‡ê²Œ í•˜ì‹¤ê±°ì—ìš”!!!`, scene:"ì¸íŠ¸ë¡œ2" },
    { text:`ë°•ì‚¬: ë‚´ê°€ ë¯¸ì•ˆí•˜ë‹¤ ê´‘ì¹ ì•„...`, scene:"ì¸íŠ¸ë¡œ3" },
    { text:`ì¡°ìˆ˜: ëŠ¦ì—ˆì–´ìš”. ì´ê±°ë‚˜ ë°›ê³  êº¼ì§€ì„¸ìš”. (ë§Œì› í•œ ì¥ì„ ë˜ì§€ê³  ë– ë‚œë‹¤)`, scene:"ì¸íŠ¸ë¡œ3" },
    { text:`ë°•ì‚¬: ...ì´ì   ì§„ì§œ í˜¼ìê°€ ëì–´.......`, scene:"ì¸íŠ¸ë¡œ3" },
    { text:`ë°•ì‚¬: ì•ˆë˜ê² ì–´! ë‚˜ ëª©ë°•ì‚¬, ê¼­ ìš°ì£¼ìµœê°• ë°•ì‚¬ê°€ ë  í…Œë‹¤!!!`, scene:"ì¸íŠ¸ë¡œ4" },
    { text:`ë°•ì‚¬ëŠ” ê´‘ì¹ ì´ì˜ 'ë§ˆì§€ë§‰ 1ë§Œì›'ì„ ë“¤ê³  ì¸ê·¼ ê³ ë¬¼ê°€ê²Œë¥¼ ë– ì˜¬ë ¸ë‹¤...`, scene:"ì¸íŠ¸ë¡œ4" },
  ];
  let introIdx=0;
  let currentLocation="ì¸íŠ¸ë¡œ";

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !typingLock && currentLocation==="ì¸íŠ¸ë¡œ"){
      if(introIdx < intro.length){
        const line=intro[introIdx++]; say(line.text, line.scene);
      }else{ go("íŠœí† ë¦¬ì–¼"); }
    }
  });

  // ---------- Location/Actions ----------
  function buildLocationList(){
    locationList.innerHTML="";
    LOCATIONS.forEach(loc=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent = (loc===currentLocation?`âœ… ${loc}`:loc);
      b.onclick=()=>{ go(loc); locationList.style.display="none"; };
      locationList.appendChild(b);
    });
  }
  document.addEventListener("click",(e)=>{
    if(!locationList.contains(e.target) && e.target!==locationBtn){ locationList.style.display="none"; }
    if(!inventoryPanel.contains(e.target) && e.target!==inventoryBtn){ inventoryPanel.style.display="none"; }
    if(!imagePanel.contains(e.target) && e.target!==imageBtn && e.target!==applyImg && e.target!==fileInput){ imagePanel.style.display="none"; }
  });
  locationBtn.onclick=()=>{
    if(locationList.style.display==="block"){ locationList.style.display="none"; }
    else{ buildLocationList(); locationList.style.display="block"; }
  };
  inventoryBtn.onclick=()=>{ inventoryPanel.style.display = (inventoryPanel.style.display==="block")?"none":"block"; };
  imageBtn.onclick=()=>{ imagePanel.style.display = (imagePanel.style.display==="block")?"none":"block"; };

  // ì´ë¯¸ì§€ íŒ¨ë„ ì´ˆê¸°í™” (ì¸íŠ¸ë¡œ í‚¤ í¬í•¨)
  (function fillSceneSelect(){
    const keys = ["ì¸íŠ¸ë¡œ1","ì¸íŠ¸ë¡œ2","ì¸íŠ¸ë¡œ3","ì¸íŠ¸ë¡œ4", ...LOCATIONS];
    keys.forEach(k=>{
      const opt=document.createElement("option");
      opt.value=k; opt.textContent=k;
      sceneSelect.appendChild(opt);
    });
  })();
  applyImg.onclick=()=>{
    const file=fileInput.files?.[0];
    const key=sceneSelect.value;
    if(!file) return alert("ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
    const url=URL.createObjectURL(file);
    SCENE_IMAGES[key]=url;
    if(currentLocation===key) showScene(key);
    alert(`ì¥ë©´ "${key}" ì´ë¯¸ì§€ ë“±ë¡ ì™„ë£Œ!`);
  };

  function setActions(list=[]){
    actionOverlay.innerHTML="";
    list.forEach(cfg=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent=cfg.label;
      if(cfg.primary) b.style.outline=`1px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`;
      b.onclick=cfg.onClick;
      actionOverlay.appendChild(b);
    });
  }

  function go(loc){
    currentLocation = loc;
    locationTag.textContent = loc;
    showScene(loc);
    updateStats();
    // ì¥ì†Œë³„ ì•ˆë‚´ + ì•¡ì…˜
    if(loc==="íŠœí† ë¦¬ì–¼"){
      const actions=[];
      if(!starterClaimed){
        actions.push({
          label:"ì´ˆê¸° ë³´ìƒ ë°›ê¸° (1íšŒ)",
          primary:true,
          onClick:()=>{
            if(starterClaimed) return;
            starterClaimed = true;
            gainItem("ìŠ¤í¬ë©",2); player.honor+=1; player.turn++; updateStats();
            say("ì´ˆê¸° ë³´ìƒ ìˆ˜ë ¹: ìŠ¤í¬ë© x2, ëª…ì˜ˆ +1", "íŠœí† ë¦¬ì–¼");
            setActions([]); // ë²„íŠ¼ ì œê±°
          }
        });
      }
      setActions(actions);
      say("íŠœí† ë¦¬ì–¼: ì¢Œì¸¡ ìŠ¤íƒ¯ì„ í™•ì¸í•˜ê³ , í•˜ë‹¨ ëŒ€ì‚¬ëŠ” ì—”í„°ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¢Œí•˜ë‹¨ 'ì¥ì†Œ ì´ë™'ìœ¼ë¡œ ë‹¤ë¥¸ ì¥ì†Œë¡œ ì´ë™í•˜ì„¸ìš”.", "íŠœí† ë¦¬ì–¼");
    }
    else if(loc==="ê³ ë¬¼ê°€ê²Œ"){
      setActions(JUNK_EXCHANGE.map(e=>({
        label:`êµí™˜: ${e.name} (ëˆ ${e.money} + ëª…ì˜ˆ ${e.honor})`,
        onClick:()=>{
          if(player.money<e.money) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          if(player.honor<e.honor) return alert("ëª…ì˜ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          player.money-=e.money; player.honor-=e.honor; gainItem(e.name,1); player.turn++; updateStats();
          say(`${e.name}ì„(ë¥¼) íšë“í–ˆë‹¤!`, "ê³ ë¬¼ê°€ê²Œ");
        }
      })));
      say("ê³ ë¬¼ê°€ê²Œ: ëˆê³¼ ëª…ì˜ˆë¥¼ ì§€ë¶ˆí•´ ì•„ì´í…œì„ ì–»ìŠµë‹ˆë‹¤.", "ê³ ë¬¼ê°€ê²Œ");
    }
    else if(loc==="í‘¸ì½”ìƒì "){
      setActions(FUKO_SHOP.map(it=>({
        label:`êµ¬ë§¤: ${it.name} (${it.price}ì›)`,
        onClick:()=>{
          if(player.money<it.price) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          player.money-=it.price; gainItem(it.name,1); player.turn++; updateStats();
          say(`${it.name} êµ¬ë§¤ ì™„ë£Œ.`, "í‘¸ì½”ìƒì ");
        }
      })));
      say("í‘¸ì½”ìƒì : ì¼ë°˜ ì•„ì´í…œ íŒë§¤ ì¤‘.", "í‘¸ì½”ìƒì ");
    }
    else if(loc==="í—¬ìŠ¤ì¥"){
      setActions([{
        label:"ìš´ë™í•˜ê¸° (2000ì›, ìµœëŒ€ì²´ë ¥+5)",
        primary:true,
        onClick:()=>{
          if(player.money<2000) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          player.money-=2000; player.hpMax+=5; player.hp=Math.min(player.hpMax, player.hp+5);
          player.turn++; updateStats(); say("ë•€ì„ ë¶ˆíƒœì› ë‹¤! ìµœëŒ€ì²´ë ¥ +5", "í—¬ìŠ¤ì¥");
        }
      }]);
      say("í—¬ìŠ¤ì¥: 2000ì›ì„ ë‚´ê³  ìµœëŒ€ì²´ë ¥ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "í—¬ìŠ¤ì¥");
    }
    else if(loc==="ë„ì„œê´€"){
      setActions([{
        label:"ë…ì„œí•˜ê¸° (2000ì›, ì§€ëŠ¥+1)",
        primary:true,
        onClick:()=>{
          if(player.money<2000) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          player.money-=2000; player.int+=1; player.turn++; updateStats(); say("ì§€ì‹ì´ ìŠ¤ë©°ë“ ë‹¤! ì§€ëŠ¥ +1", "ë„ì„œê´€");
        }
      }]);
      say("ë„ì„œê´€: ì§€ëŠ¥ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ë„ì„œê´€");
    }
    else if(loc==="ë„ë°•ì¥"){
      setActions([{
        label:"ìŠ¬ë¡¯ ëŒë¦¬ê¸° (1000ì›)",
        primary:true,
        onClick:()=>slotSpin()
      }]);
      say("ë„ë°•ì¥: 3ì¹¸ ìŠ¬ë¡¯, 1000ì› ë² íŒ…. (3ê°™ìŒ=10000 / 2ê°™ìŒ=3000 / ê·¸ì™¸=0)", "ë„ë°•ì¥");
    }
    else if(loc==="ê³¼í•™ì‹¤"){
      setActions([{
        label:"ê°•í™” ì‹œë„ (2000ì›, 60%)",
        primary:true,
        onClick:()=>{
          if(player.money<2000) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          player.money-=2000; player.turn++;
          if(Math.random()<0.6){ player.atk+=1; say("ê°•í™” ì„±ê³µ! ê³µê²©ë ¥ +1", "ê³¼í•™ì‹¤"); }
          else { say("ê°•í™” ì‹¤íŒ¨... ë³€í™” ì—†ìŒ", "ê³¼í•™ì‹¤"); }
          updateStats();
        }
      }]);
      say("ê³¼í•™ì‹¤: ì¥ë¹„ ê°•í™” ì—°êµ¬.", "ê³¼í•™ì‹¤");
    }
    else if(loc==="ì œë ¨ì†Œ"){
      setActions([{
        label:"ì œì‘: ìŠ¤í¬ë©ì†Œë“œ (ìŠ¤í¬ë© x3)",
        primary:true,
        onClick:()=>{
          if((player.inventory["ìŠ¤í¬ë©"]||0)<3) return alert("ìŠ¤í¬ë©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          consumeItem("ìŠ¤í¬ë©",3); gainItem("ìŠ¤í¬ë©ì†Œë“œ",1); player.turn++; updateStats();
          say("ì œì‘ ì™„ë£Œ! ìŠ¤í¬ë©ì†Œë“œ íšë“ (ê³µ+3)", "ì œë ¨ì†Œ");
        }
      }]);
      say("ì œë ¨ì†Œ: ì¬ë£Œë¡œ ë¬´ê¸°ë¥¼ ë§Œë“­ë‹ˆë‹¤.", "ì œë ¨ì†Œ");
    }
    else if(loc==="ì •ë³´ê±°ë˜ì†Œ"){
      setActions([{
        label:"íŒíŠ¸ êµ¬ë§¤ (1500ì›)",
        primary:true,
        onClick:()=>{
          if(player.money<1500) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          player.money-=1500; player.turn++; updateStats();
          say("íŒíŠ¸: ì˜¤ëŠ˜ ë˜ì „ì€ 'ì „ê¸°'ì— ì•½í•˜ë‹¤. ì¹˜ëª…íƒ€ë¥¼ ë…¸ë ¤ë¼!", "ì •ë³´ê±°ë˜ì†Œ");
        }
      }]);
      say("ì •ë³´ê±°ë˜ì†Œ: ëˆìœ¼ë¡œ ì •ë³´ë¥¼ ì‚½ë‹ˆë‹¤.", "ì •ë³´ê±°ë˜ì†Œ");
    }
    else if(loc==="íŒë§¤ì†Œ"){
      const acts=[];
      for(const [k,v] of Object.entries(player.inventory)){
        const base = ITEMS[k]?.price ?? 100;
        acts.push({
          label:`íŒë§¤: ${k} x1 (${Math.floor(base*0.5)}ì›)`,
          onClick:()=>{
            if(!consumeItem(k,1)) return alert("ìˆ˜ëŸ‰ ë¶€ì¡±");
            player.money += Math.floor(base*0.5);
            player.turn++; updateStats(); say(`${k} íŒë§¤ ì™„ë£Œ.`, "íŒë§¤ì†Œ");
            go("íŒë§¤ì†Œ"); // ëª©ë¡ ê°±ì‹ 
          }
        });
      }
      setActions(acts);
      say(acts.length? "íŒë§¤ì†Œ: ì•„ì´í…œì„ íŒ” ìˆ˜ ìˆìŠµë‹ˆë‹¤." : "íŒë§¤ì†Œ: íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.", "íŒë§¤ì†Œ");
    }
    else if(loc==="ë˜ì „"){
      startDungeon();
    }
    updateStats();
  }

  // ---------- Gambling (Slots) ----------
  function slotSpin(){
    if(player.money<1000) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
    player.money-=1000; player.turn++;
    const symbols=["â˜…","ğŸ”§","âš¡","ğŸ’","ğŸ”¬"];
    const r1=symbols[Math.floor(Math.random()*symbols.length)];
    const r2=symbols[Math.floor(Math.random()*symbols.length)];
    const r3=symbols[Math.floor(Math.random()*symbols.length)];
    let reward=0, note="";
    if(r1===r2 && r2===r3){ reward=10000; note="ëŒ€ë°•!"; }
    else if(r1===r2 || r2===r3 || r1===r3){ reward=3000; note="ì¤‘ë°•!"; }
    if(reward>0){ player.money+=reward; say(`ìŠ¬ë¡¯: [ ${r1} | ${r2} | ${r3} ]  â†’ ${note} +${reward.toLocaleString()}ì›`, "ë„ë°•ì¥"); }
    else { say(`ìŠ¬ë¡¯: [ ${r1} | ${r2} | ${r3} ]  â†’ ê½...`, "ë„ë°•ì¥"); }
    updateStats();
  }

  // ---------- Dungeon ----------
  function startDungeon(){
    showScene("ë˜ì „");
    dungeonExtra.classList.remove("hidden");
    const enemy = { name:"íí—ˆì˜ ê³ ë¸”ë¦°", hpMax:60, hp:60, atk:8, reward:1200 };
    const buttons = [];
    function refresh(){ updateStats(); }
    say(`ë˜ì „: ${enemy.name} ë“±ì¥! (ë§ˆë‚˜/ì¹˜ëª…íƒ€ í‘œì‹œ í™œì„±í™”)`, "ë˜ì „");

    buttons.push({
      label:"ê³µê²©",
      primary:true,
      onClick:()=>{
        const crit = Math.random()*100 < player.crit;
        const dmg = Math.max(1, player.atk - 0) * (crit?2:1);
        enemy.hp = Math.max(0, enemy.hp - dmg);
        say(`ê³µê²©! ${crit?"ì¹˜ëª…íƒ€! ":""}${dmg} í”¼í•´`, "ë˜ì „");
        player.turn++;
        if(enemy.hp<=0) return win();
        enemyTurn(); refresh();
      }
    });
    buttons.push({
      label:"ìŠ¤í‚¬(ë§ˆë‚˜10)",
      onClick:()=>{
        if(player.mp<10) return alert("ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        player.mp-=10;
        const dmg = Math.max(1, (player.atk + Math.floor(player.int*0.5)) * 2);
        enemy.hp = Math.max(0, enemy.hp - dmg);
        say(`ìŠ¤í‚¬ ë°œë™! ${dmg} í”¼í•´`, "ë˜ì „");
        player.turn++;
        if(enemy.hp<=0) return win();
        enemyTurn(); refresh();
      }
    });
    buttons.push({
      label:"ë„ë§",
      onClick:()=>{ say("ë¬´ì‚¬íˆ ë¹ ì ¸ë‚˜ì™”ë‹¤...", "íŠœí† ë¦¬ì–¼"); go("íŠœí† ë¦¬ì–¼"); }
    });
    setActions(buttons);

    function enemyTurn(){
      const edmg = Math.max(1, enemy.atk - player.def);
      player.hp = Math.max(0, player.hp - edmg);
      if(player.hp<=0){ lose(); }
    }
    function win(){
      say(`ìŠ¹ë¦¬! ${enemy.reward}ì›, ëª…ì˜ˆ +1, ìŠ¤í¬ë© x1 íšë“`, "ë˜ì „");
      player.money+=enemy.reward; player.honor+=1; gainItem("ìŠ¤í¬ë©",1);
      player.turn++; updateStats();
      setActions([{label:"ë˜ì „ ì¢…ë£Œ", primary:true, onClick:()=>go("íŠœí† ë¦¬ì–¼")}]);
    }
    function lose(){
      say("íŒ¨ë°°... ê°€ê¹ŒìŠ¤ë¡œ íƒˆì¶œí–ˆë‹¤. (ì²´ë ¥ 1)", "ë˜ì „");
      player.hp=1; player.turn++; updateStats();
      setActions([{label:"ë˜ì „ ë‚˜ê°€ê¸°", primary:true, onClick:()=>go("íŠœí† ë¦¬ì–¼")}]);
    }
  }

  // ---------- Start ----------
  function start(){
    // ì¥ë©´ ì„ íƒ ë¦¬ìŠ¤íŠ¸ì— í˜„ì¬ ìœ„ì¹˜ë“¤ ì´ë¯¸ ì±„ì›Œë‘ 
    showScene("ì¸íŠ¸ë¡œ1");
    updateStats();
    const first = intro[introIdx++]; say(first.text, first.scene);
  }

  start();
})();
</script>
</body>
</html>
